name: Database Sync

on:
  # Manual trigger only - database migration is a deliberate action
  workflow_dispatch:
    inputs:
      source_backend:
        description: 'Source database backend'
        required: true
        type: choice
        options:
          - turso
          - postgres
        default: turso
      dest_backend:
        description: 'Destination database backend'
        required: true
        type: choice
        options:
          - postgres
          - turso
        default: postgres
      tables:
        description: 'Tables to sync (comma-separated, leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (report only, no changes)'
        required: false
        type: boolean
        default: true
      create_tables:
        description: 'Create tables in destination if they do not exist'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  sync:
    runs-on: ubuntu-latest

    # Prevent concurrent syncs to avoid conflicts
    concurrency:
      group: database-sync
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate inputs
        run: |
          if [ "${{ github.event.inputs.source_backend }}" == "${{ github.event.inputs.dest_backend }}" ]; then
            echo "::error::Source and destination backends cannot be the same"
            exit 1
          fi

      - name: Run database sync
        id: sync
        env:
          # Source database configuration
          SOURCE_DATABASE_BACKEND: ${{ github.event.inputs.source_backend }}
          # Turso source credentials
          SOURCE_TURSO_DATABASE_URL: ${{ secrets.SOURCE_TURSO_DATABASE_URL || secrets.TURSO_DATABASE_URL }}
          SOURCE_TURSO_AUTH_TOKEN: ${{ secrets.SOURCE_TURSO_AUTH_TOKEN || secrets.TURSO_AUTH_TOKEN }}
          # PostgreSQL source credentials
          SOURCE_POSTGRES_URL: ${{ secrets.SOURCE_POSTGRES_URL || secrets.POSTGRES_URL }}

          # Destination database configuration
          DEST_DATABASE_BACKEND: ${{ github.event.inputs.dest_backend }}
          # Turso destination credentials
          DEST_TURSO_DATABASE_URL: ${{ secrets.DEST_TURSO_DATABASE_URL }}
          DEST_TURSO_AUTH_TOKEN: ${{ secrets.DEST_TURSO_AUTH_TOKEN }}
          # PostgreSQL destination credentials
          DEST_POSTGRES_URL: ${{ secrets.DEST_POSTGRES_URL }}
        run: |
          cd scripts

          # Build command
          CMD="python sync_database.py"

          # Add flags
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            CMD="$CMD --dry-run"
          fi

          if [ "${{ github.event.inputs.create_tables }}" == "false" ]; then
            CMD="$CMD --no-create-tables"
          fi

          if [ -n "${{ github.event.inputs.tables }}" ]; then
            CMD="$CMD --tables '${{ github.event.inputs.tables }}'"
          fi

          echo "Running: $CMD"
          eval $CMD

      - name: Generate summary report
        if: always()
        env:
          SOURCE_DATABASE_BACKEND: ${{ github.event.inputs.source_backend }}
          SOURCE_TURSO_DATABASE_URL: ${{ secrets.SOURCE_TURSO_DATABASE_URL || secrets.TURSO_DATABASE_URL }}
          SOURCE_TURSO_AUTH_TOKEN: ${{ secrets.SOURCE_TURSO_AUTH_TOKEN || secrets.TURSO_AUTH_TOKEN }}
          SOURCE_POSTGRES_URL: ${{ secrets.SOURCE_POSTGRES_URL || secrets.POSTGRES_URL }}
          DEST_DATABASE_BACKEND: ${{ github.event.inputs.dest_backend }}
          DEST_TURSO_DATABASE_URL: ${{ secrets.DEST_TURSO_DATABASE_URL }}
          DEST_TURSO_AUTH_TOKEN: ${{ secrets.DEST_TURSO_AUTH_TOKEN }}
          DEST_POSTGRES_URL: ${{ secrets.DEST_POSTGRES_URL }}
        run: |
          echo "## Database Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** ${{ github.event.inputs.source_backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Destination:** ${{ github.event.inputs.dest_backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Create tables:** ${{ github.event.inputs.create_tables }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.tables }}" ]; then
            echo "- **Tables:** ${{ github.event.inputs.tables }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Tables:** all" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show JSON results if available
          cd scripts
          echo "### Sync Details" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Re-run with JSON output for summary
          CMD="python sync_database.py --json"
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            CMD="$CMD --dry-run"
          fi
          if [ "${{ github.event.inputs.create_tables }}" == "false" ]; then
            CMD="$CMD --no-create-tables"
          fi
          if [ -n "${{ github.event.inputs.tables }}" ]; then
            CMD="$CMD --tables '${{ github.event.inputs.tables }}'"
          fi

          # Only show dry run results in summary to avoid duplicate syncing
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            eval $CMD >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Could not generate JSON summary"
          else
            echo "Sync completed. See logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs-${{ github.run_number }}
          path: scripts/logs/
          retention-days: 30
          if-no-files-found: ignore
