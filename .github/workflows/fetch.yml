name: Fetch YouTube Metadata

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      channel:
        description: 'Single channel to fetch (leave empty to use config)'
        required: false
        type: string
      backfill:
        description: 'Run full backfill (ignore incremental)'
        required: false
        type: boolean
        default: false
      max_videos:
        description: 'Max videos per channel (default: unlimited)'
        required: false
        type: number
      max_video_age:
        description: 'Max video age in days (default: unlimited)'
        required: false
        type: number
      skip_comments:
        description: 'Skip fetching comments'
        required: false
        type: boolean
        default: false
      reset_quota:
        description: 'Reset quota counter (use if quota tracking was corrupted)'
        required: false
        type: boolean
        default: false
  
  # Scheduled runs - 4 times daily
  schedule:
    - cron: '0 0 * * *'   # Midnight UTC
    - cron: '0 6 * * *'   # 6 AM UTC
    - cron: '0 12 * * *'  # Noon UTC
    - cron: '0 18 * * *'  # 6 PM UTC

env:
  PYTHON_VERSION: '3.11'

jobs:
  fetch:
    runs-on: ubuntu-latest
    
    # Prevent concurrent runs to avoid database conflicts
    concurrency:
      group: youtube-fetch
      cancel-in-progress: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure config exists
        run: |
          if [ ! -f "config/channels.yaml" ]; then
            if [ -f "config/channels.example.yaml" ]; then
              cp config/channels.example.yaml config/channels.yaml
              echo "Using example config"
            else
              echo "No config file found!"
              exit 1
            fi
          fi

      - name: Fetch YouTube data
        id: fetch
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: |
          cd scripts
          
          # Build command
          if [ -n "${{ github.event.inputs.channel }}" ]; then
            CMD="python fetch.py --channel '${{ github.event.inputs.channel }}'"
          else
            CMD="python fetch.py --config ../config/channels.yaml"
          fi
          
          # Add flags
          if [ "${{ github.event.inputs.backfill }}" == "true" ]; then
            CMD="$CMD --backfill"
          fi
          
          if [ -n "${{ github.event.inputs.max_videos }}" ]; then
            CMD="$CMD --max-videos ${{ github.event.inputs.max_videos }}"
          fi
          
          if [ -n "${{ github.event.inputs.max_video_age }}" ]; then
            CMD="$CMD --max-video-age ${{ github.event.inputs.max_video_age }}"
          fi
          
          if [ "${{ github.event.inputs.skip_comments }}" == "true" ]; then
            CMD="$CMD --skip-comments"
          fi
          
          if [ "${{ github.event.inputs.reset_quota }}" == "true" ]; then
            CMD="$CMD --reset-quota"
          fi
          
          echo "Running: $CMD"
          eval $CMD

      - name: Generate summary report
        if: always()
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: |
          cd scripts
          
          echo "## YouTube Fetch Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Transcripts must be fetched locally with \`fetch_transcripts.py\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Summary stats
          echo "### Database Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          python analyse.py --report summary >> $GITHUB_STEP_SUMMARY || echo "Could not generate summary"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Channels
          echo "### Tracked Channels" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          python analyse.py --report channels >> $GITHUB_STEP_SUMMARY || echo "Could not list channels"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Recent fetch history
          echo "### Recent Fetches" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          python analyse.py --report fetch-history >> $GITHUB_STEP_SUMMARY || echo "Could not get fetch history"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fetch-logs-${{ github.run_number }}
          path: scripts/logs/
          retention-days: 30
